# ACME Hugger

Make load balancers like Nginx have native ACME capabilities.

## Why

There are many pain points with coordinating an ACME tool (e.g., [acme.sh](https://github.com/acmesh-official/acme.sh), [lego](https://go-acme.github.io/lego/)) and a load balancer:

1. The load balancer cannot have HTTPS configuration before the certificates are obtained. So you need to edit the configuration at least once, and also manually reload the load balancer after that.
1. Making the load balancer read challenge answers generated by the ACME tool can be quite challenging.
1. Setting up cron jobs to periodically renew the certificates and reload the load balancer after that can also be challenging.
1. With the above drawbacks, provisioning an HTTPS web server in an automatic way becomes, again, quite challenging.

With ACME Hugger, you just add some preprocessed acme directives written in the load balancer's configuration syntax, and let ACME Hugger handle all of the above for you, automatically.

## How

Given this Nginx configuration, notice that the acme directives are only recognized by ACME Hugger:

```nginx
# nginx.conf
http {
    acme_email acme@example.com;

    server {
        listen 80;
        acme_defer listen 443 ssl;
        server_name example.com;
    }
}
```

Start ACME Hugger for Nginx (notice the h in nginxh):

```
$ nginxh -c nginx.conf -g 'daemon off;'
```

ACME Hugger first changes this configuration into one with which Nginx is able to answer ACME HTTP01 challenges:

```nginx
http {
    server {
        listen 80;
        server_name example.com;
        location /.well-known/acme-challenge/ {
            root <acme challenge dir>;
        }
    }
}
```

It then starts Nginx with this configuration file, and talks to an ACME CA server (by default Let's Encrypt) to obtain the certificate for example.com, after which it updates the configuration file to:

```nginx
http {
    server {
        listen 80;
        listen 443 ssl;
        server_name example.com;
        location /.well-known/acme-challenge/ {
            root <acme challenge dir>;
        }
        ssl_certificate <acme certs dir>/example.com.fullchain.crt;
        ssl_certificate_key <acme certs dir>/example.com.key;
        ssl_trusted_certificate <acme cert dir>/example.com.chain.crt;
    }
}
```
And reloads Nginx, and also wait for the right moment to automatically renew the certificates.

Notice that directives prefixed by `acme_defer` are hidden until certificates are obtained, at which point certificate related directives are also appended. This is needed because Nginx considers it an error listening `ssl` without the certificate related directives.

## Install

### Go

```
$ go install github.com/hgl/acmehugger/nginx/nginxh
```

### Docker

```
$ docker pull hgl0/nginxh
```

See the [Docker Hub page](https://hub.docker.com/r/hgl0/nginxh) for details
## Reference

Currently, if HTTP01 challenge is used, all HTTP `server`s are added the `location /.well-known/acme-challenge/ { ... }` directive, to not complicate the logic. This might get optimized in the future.

After an ACME certificate is obtained, corresponding `ssl_certificate`, `ssl_certificate_key` and `ssl_trusted_certificate` directive are added to `server { ... }`. No other directives are added.

ACME Hugger is designed to be idempotent, meaning you can restart it during the process, and it will continue issuing/renewing certificates or wait for the next renew time.

### CLI

`nginxh` passes all arguments to `nginx`, changing only the configuration file path.

By default, the nginx binary is search in `$PATH`, but can be specified explicitly with the environment variable `NGINXBIN`.

Setting the environment variable `ACMEHUGGER_DEBUG` to `1` enables more verbose logging.

### Scope

Directives in an inner block overrides those in the outer block:

```nginx
http {
    acme_server a.example.com;
    server {
        acme_server b.example.com;
    }
}
```

`acme_server b.example.com` will be used for `server { ... }`.

### Directives

#### server_name
Default: server_name "";<br>
Context: server

Domains used in the ACME certificate. Ignored if the domains are specified with `~` ( i.e., regular expression), in which case use `acme_domain`, which also supports wildcard domains.

#### acme_email email
Default: acme_email ""<br>
Context: main, http, server, acme

Email used for registration and recovery contact.

This directive is removed after read.

#### acme_server url
Default: acme_server ""<br>
Context: main, http, server, acme

CA hostname (and optionally :port). If it's empty, `acme_staging` determines the default value.

This directive is removed after read.

#### acme_staging on | off
Default: acme_staging off<br>
Context: main, http, server, acme

Ignored if `acme_server` is non-empty, otherwise, Let's Encrypt's production or staging URL is used, respectively.

This directive is removed after read.

##### acme_key ec256 | ec384 | rsa2048 | rsa3072 | rsa4096 | rsa8192
Default: acme_key ec256<br>
Context: main, http, server, acme

Key type to use for private keys.

This directive is removed after read.

#### acme_challenge http | dns
Default: acme_challenge http<br>
Context: main, http, server, acme

ACME challenge to use.

This directive is removed after read.

#### acme_days number
Default: acme_days 30<br>
Context: main, http, server, acme

The number of days left on a certificate to renew it.

This directive is removed after read.

#### acme_dns name
Default: -<br>
Context: main, http, server, acme

DNS provider to use. For a list of valid names, [see lego's document](https://go-acme.github.io/lego/dns/). Use each DNS provider's "code" value.

For example, for Amazon Route 53:

```
acme_dns route53;
```

This directive is removed after read.

#### acme_dns_option key value

Options to use for the specified `acme_dns`. For a list of valid keys, [see lego's document](https://go-acme.github.io/lego/dns/).
They should be the lowercase of "Environment Variable Name" values.

For example, for Amazon Route 53:

```
acme_dns route53;
acme_dns_option aws_access_key_id xxxx;
```

This directive is removed after read.

#### acme_defer directive
Default: -<br>
Context: server, acme

Directive after it is omitted from the configuration until the certificate exists.

#### acme_domain domain ...
Default: -<br>
Context: server, acme

Domains used in the ACME certificate. It has higher priority than `server_name`, and supports wildcard.

This directive is removed after read.

#### acme \{ ... }
Default: -<br>
Context: main

Allow obtaining certificates that aren't attached to any specific `server { ... }`.

This directive is removed after read.

### Hooks

Whenever a certificate is issued or renewed, ACME Hugger will call executables in the hooks directory (`/usr/share/acmehugger/hook.d` by default) with the following environment variables set:

| Names |
| --- |
| ACME_SERVER |
| ACME_EMAIL |
| ACME_DOMAIN |

## Todo

- Docker readme
- HAProxy support
- Windows support

## Credit

ACME Hugger uses lego under the hood.
