# ACME Hugger

Make load balancers like Nginx have native ACME capabilities.

- [How to Install](https://github.com/hgl/acmehugger/blob/main/docs/Install.md)
- [Reference](https://github.com/hgl/acmehugger/blob/main/docs/Reference.md)

## Why

There are many pain points with coordinating an ACME tool (e.g., [acme.sh](https://github.com/acmesh-official/acme.sh), [lego](https://go-acme.github.io/lego/)) and a load balancer:

1. The load balancer cannot have HTTPS configuration before the certificates are obtained. So you need to edit the configuration at least once, and also manually reload the load balancer after that.
1. Making the load balancer read challenge answers generated by the ACME tool can be quite challenging.
1. Setting up cron jobs to periodically renew the certificates and reload the load balancer after that can also be challenging.
1. With the above drawbacks, provisioning an HTTPS web server in an automatic way becomes, again, quite challenging.

With ACME Hugger, you just add some preprocessed acme directives written in the load balancer's configuration syntax, and let ACME Hugger handle all of the above for you, automatically.

## How

Given this Nginx configuration, notice that the acme directives are only recognized by ACME Hugger:

```nginx
# nginx.conf
http {
    acme_email acme@example.com;

    server {
        listen 80;
        acme_defer listen 443 ssl;
        server_name example.com;
    }
}
```

Start ACME Hugger for Nginx (notice the h in nginxh):

```
$ nginxh -c nginx.conf -g 'daemon off;'
```

ACME Hugger first changes this configuration into one with which Nginx is able to answer ACME HTTP01 challenges:

```nginx
http {
    server {
        listen 80;
        server_name example.com;
        location /.well-known/acme-challenge/ {
            root <acme challenge dir>;
        }
    }
}
```

It then starts Nginx with this configuration file, and talks to an ACME CA server (by default Let's Encrypt) to obtain the certificate for example.com, after which it updates the configuration file to:

```nginx
http {
    server {
        listen 80;
        listen 443 ssl;
        server_name example.com;
        location /.well-known/acme-challenge/ {
            root <acme challenge dir>;
        }
        ssl_certificate <acme certs dir>/example.com.fullchain.crt;
        ssl_certificate_key <acme certs dir>/example.com.key;
        ssl_trusted_certificate <acme cert dir>/example.com.chain.crt;
    }
}
```
And reloads Nginx, and also wait for the right moment to automatically renew the certificates.

Notice that directives prefixed by `acme_defer` are hidden until certificates are obtained, at which point certificate related directives are also appended. This is needed because Nginx considers it an error listening `ssl` without the certificate related directives.

## Todo

- HAProxy support
- Windows support

## Credit

ACME Hugger uses lego under the hood.
